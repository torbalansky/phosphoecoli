{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
    .protein-viewer {
        cursor: pointer;
    }
</style>
<div class="container-fluid protein-details mt-4">
    <div class="row">
        <div class="col-lg-12"> 
            <div class="row justify-content-end mb-3">
                <div class="col-auto">
                    <button class="btn btn-outline-light" style="font-weight: 600;" onclick="goBack()">Back to Search</button>
                </div>
            </div>
            <div class="card text-left">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #63709a; color: white;">
                    <h5 class="protein-name">{{ protein.protein_name }} - <em>{{ protein.coli_strain }}</em></h5>
                    <div class="download-overlay">
                        <a href="{% url 'export_protein_as_pdf' protein.pk %}" class="btn-fa" title="Download as PDF">
                            <i class="fas fa-download" style="color: white"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body protein-details-container">
                    <div class="row">
                        <div class="col-lg-7"> 
                            <table class="table details">
                                <thead>
                                    <tr>
                                        <th scope="col">UniProt</th>
                                        <th scope="col">Gene</th>
                                        <th scope="col" title="Position within protein.">Position</th>
                                        <th class="hide-on-sm" scope="col" title="Window -/+ 5 amino acids.">Window</th>
                                        <th class="hide-on-sm" scope="col">Method</th>
                                        <th scope="col" title="Reference/s.">Ref</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="highlighted-row">
                                        <td>
                                            {% if protein.uniprot_url %}
                                                <a  style="text-decoration: none;" href="{{ protein.uniprot_url }}" target="_blank">{{ protein.uniprot_code }}</a>
                                            {% else %}
                                                {{ protein.uniprot_code }}
                                            {% endif %}
                                        </td>
                                        <td>{{ protein.gene_name }}</td>
                                        <td>{{ protein.modification_type }}{{ protein.position }}</td>
                                        <td class="hide-on-sm" style="font-family: 'Courier New', Courier, monospace;">{{ protein.window_5_aa }}</td>
                                        <td class="hide-on-sm" title="{% if protein.method == 'LTP' %}This modification site, identified through Low Throughput (LTP) method, was discovered using a technique distinct from mass spectrometry (MS).{% endif %}">{{ protein.method }}</td>
                                        <td>
                                            <button class="btn main-ref-button" data-reference="{{ protein.reference }}" title="View reference list."><i class="fa-solid fa-arrow-down-short-wide" style="color: rgb(9, 85, 177);"></i></button>
                                            <div class="references" style="display: none;">
                                                <ul class="references-list">
                                                    {% if pmids %}
                                                    <p>Debug: {{ pmids }}</p>
                                                    {% for pmid in pmids %}
                                                        <li><a href="https://pubmed.ncbi.nlm.nih.gov/{{ pmid }}/" target="_blank">{{ pmid }}</a></li>
                                                    {% endfor %}
                                                    {% endif %}
                                                </ul>
                                                <button class="btn  clearrefButton" title="Close reference list."><i class="fa-solid fa-arrow-up-short-wide" style="color: rgb(177, 9, 9);"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% for related_protein in related_proteins %}
                                    <tr>
                                        <td></td>
                                        <td></td>
                                        <td>{{ related_protein.modification_type }}{{ related_protein.position }}</td>
                                        <td class="hide-on-sm" style="font-family: 'Courier New', Courier, monospace;">{{ related_protein.window_5_aa }}</td>
                                        <td class="hide-on-sm">{{ related_protein.method }}</td>
                                        <td>
                                            <button class="btn related-ref-button" data-reference="{{ related_protein.reference }}" title="View reference list."><i class="fa-solid fa-arrow-down-short-wide" style="color: rgb(9, 85, 177);"></i></button>
                                            <div class="references" style="display: none;">
                                                <ul class="references-list"></ul>
                                                <button class="btn clearrefButtonRelated" title="Close reference list."><i class="fa-solid fa-arrow-up-short-wide"  style="color: rgb(177, 9, 9);"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="col-lg-5">
                            {% if protein.pdb_code and protein.pdb_code != 'nan' %}
                            <div class="card mt-4">
                                <div class="card-header" style="background-color: #63709a; color: white;">
                                {% if protein.pdb_code and protein.pdb_code != 'nan' %}
                                    <a href="https://www.rcsb.org/structure/{{ protein.pdb_code }}" target="_blank" style="text-decoration: none; color: white; font-weight: 600;">PDB {{ protein.pdb_code }}</a>
                                {% endif %}
                                </div>
                                <div class="card-body protein">
                                    <div class="protein-viewer" id="protein-viewer" style="height: 300px;"></div>
                                </div>
                                <div class="card-body protein">
                                    <div class="d-flex justify-content-center">
                                        <button class="btn btn-outline-dark mt-2" id="view-3d-structure">Click here if you don't see the 3D Structure</button>
                                    </div>
                                </div>                                
                            </div>
                            {% else %}
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5>Protein Structure</h5>
                                </div>
                                <div class="card-body">
                                    <a href="{{ protein.alphafold_url }}" target="_blank" style="text-decoration: none; font-weight: 500;">Please check AlphaFold for predicted structure.</a>
                                </div>
                            </div>
                            {% endif %}
                        </div>                        
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-12">
            <div class="card mt-4 p-2">
                <div class="chart-container d-none d-md-block">{{ chart_image | safe }}</div>
                <div class="protein-sequence" style="padding: 10px;">
                    <h5 style="font-family: Barlow, sans-serif; font-size: 14px;"> >{{ protein.uniprot_code }}</h5>
                    {% for position, aa in sequence_with_positions %}
                        {% if position == protein.position %}
                            <span class="phosphosite-highlight">{{ aa }}</span>
                        {% elif position in related_positions %}
                            <span class="related-phosphosite-highlight">{{ aa }}</span>
                        {% else %}
                            <span>{{ aa }}</span>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="card mt-4">
                    <div class="card-header">
                        Cross-references to other databases:
                        {% if protein.uniprot_url %}
                            <a href="{{ protein.uniprot_url }}" target="_blank">UniProt</a> |
                        {% endif %}
                        {% if protein.pdb_code and protein.pdb_code != 'nan' %}
                            <a href="https://www.rcsb.org/structure/{{ protein.pdb_code }}" target="_blank">PDB</a> |
                        {% endif %}
                        <a href="{{ protein.alphafold_url }}" target="_blank">AlphaFold</a>
                        {% if not protein.uniprot_url and not protein.pdb_code and protein.pdb_code == 'nan' %}
                            Not available
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/gh/arose/ngl@v0.10.4-1/dist/ngl.js"></script>
    <script>
        $(document).ready(function() {
            $('.main-ref-button, .related-ref-button').click(function() {
                var referenceData = $(this).data('reference');
                console.log("Reference data:", referenceData);
                var pmids = String(referenceData).split(';'); 
                var referencesContainer = $(this).closest('tr').find('.references');
                var referencesList = referencesContainer.find('.references-list');
                referencesList.empty(); 
                pmids.forEach(function(pmid) {
                    if (!isNaN(pmid.trim())) {
                        var listItem = $('<li><a href="https://pubmed.ncbi.nlm.nih.gov/' + pmid.trim() + '/" target="_blank">PMID: ' + pmid.trim() + '</a></li>');
                    } else {
                        var listItem = $('<li>' + pmid.trim() + '</li>');
                    }
                    referencesList.append(listItem);
                });
                referencesContainer.show();
                $(this).hide();
            });
    
            $(document).on('click', '.clearrefButton, .clearrefButtonRelated', function() {
                var referencesContainer = $(this).closest('.references');
                referencesContainer.hide();
                $(this).closest('tr').find('.main-ref-button, .related-ref-button').show();
            });
    
            $('#view-3d-structure').click(function() {
                var pdbCode = "{{ protein.pdb_code }}";
                downloadAndReload(pdbCode);
            });
    
            function downloadAndReload(pdbCode) {
                if (pdbCode) {
                    var downloadUrl = "http://mmtf.rcsb.org/v1.0/full/" + pdbCode;
                    window.open(downloadUrl, '_blank');
                    setTimeout(function() {
                        location.reload(); 
                    }, 2000);
                } else {
                    console.error("No PDB code available for this protein.");
                }
            }
    
            var stage = new NGL.Stage("protein-viewer");
    
            window.addEventListener("resize", function(event) {
                stage.handleResize();
            }, false);
    
            function loadProteinFile(pdbCode) {
                if (pdbCode) {
                    stage.loadFile("rcsb://" + pdbCode, { defaultRepresentation: true }).then(function(component) {
                        stage.setSpin(false);
                    });
                    stage.setParameters({ backgroundColor: "white" });
                } else {
                    var proteinViewer = document.getElementById("protein-viewer");
                    proteinViewer.innerHTML = "<p>No PDB code available for this protein.</p>";
                    proteinViewer.style.display = "none";
                }
            }
    
            var pdbCode = "{{ protein.pdb_code }}";
            loadProteinFile(pdbCode);
        });
    
        function goBack() {
            window.history.back();
        }
    </script>
    
{% endblock %}
